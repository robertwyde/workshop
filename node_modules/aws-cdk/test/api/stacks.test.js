"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const lib_1 = require("../../lib");
const stacks_1 = require("../../lib/api/cxapp/stacks");
const context_providers_1 = require("../../lib/context-providers");
const settings_1 = require("../../lib/settings");
const util_1 = require("../util");
test('do not throw when selecting stack without errors', async () => {
    // GIVEN
    const stacks = testStacks();
    // WHEN
    const selected = await stacks.selectStacks(['withouterrors'], {
        defaultBehavior: stacks_1.DefaultSelection.AllStacks
    });
    stacks.processMetadata(selected);
    // THEN
    expect(selected[0].template.resource).toBe('noerrorresource');
});
test('do throw when selecting stack with errors', async () => {
    // GIVEN
    const stacks = testStacks();
    // WHEN
    const selected = await stacks.selectStacks(['witherrors'], {
        defaultBehavior: stacks_1.DefaultSelection.AllStacks
    });
    // THEN
    expect(() => stacks.processMetadata(selected)).toThrow(/Found errors/);
});
test('select behavior: all', async () => {
    // GIVEN
    const stacks = testStacks();
    // WHEN
    const x = await stacks.selectStacks([], { defaultBehavior: stacks_1.DefaultSelection.AllStacks });
    // THEN
    expect(x.length).toBe(2);
});
test('select behavior: none', async () => {
    // GIVEN
    const stacks = testStacks();
    // WHEN
    const x = await stacks.selectStacks([], { defaultBehavior: stacks_1.DefaultSelection.None });
    // THEN
    expect(x.length).toBe(0);
});
test('select behavior: single', async () => {
    // GIVEN
    const stacks = testStacks();
    // WHEN
    await expect(stacks.selectStacks([], { defaultBehavior: stacks_1.DefaultSelection.OnlySingle }))
        .rejects.toThrow('Since this app includes more than a single stack, specify which stacks to use (wildcards are supported)');
});
describe('AWS::CDK::Metadata', () => {
    test('is generated for relocatable stacks', async () => {
        var _a;
        const stacks = testStacks({ env: `aws://${cxapi.UNKNOWN_ACCOUNT}/${cxapi.UNKNOWN_REGION}`, versionReporting: true });
        const result = await stacks.synthesizeStack('withouterrors');
        const metadata = result.template.Resources && result.template.Resources.CDKMetadata;
        expect(metadata).toEqual({
            Type: 'AWS::CDK::Metadata',
            Properties: {
                // eslint-disable-next-line @typescript-eslint/no-require-imports
                Modules: `${require('../../package.json').name}=${require('../../package.json').version}`
            },
            Condition: 'CDKMetadataAvailable',
        });
        expect((_a = result.template.Conditions) === null || _a === void 0 ? void 0 : _a.CDKMetadataAvailable).toBeDefined();
    });
    test('is generated for stacks in supported regions', async () => {
        const stacks = testStacks({ env: 'aws://012345678912/us-east-1', versionReporting: true });
        const result = await stacks.synthesizeStack('withouterrors');
        const metadata = result.template.Resources && result.template.Resources.CDKMetadata;
        expect(metadata).toEqual({
            Type: 'AWS::CDK::Metadata',
            Properties: {
                // eslint-disable-next-line @typescript-eslint/no-require-imports
                Modules: `${require('../../package.json').name}=${require('../../package.json').version}`
            }
        });
    });
    test('is not generated for stacks in unsupported regions', async () => {
        const stacks = testStacks({ env: 'aws://012345678912/bermuda-triangle-1337', versionReporting: true });
        const result = await stacks.synthesizeStack('withouterrors');
        const metadata = result.template.Resources && result.template.Resources.CDKMetadata;
        expect(metadata).toBeUndefined();
    });
});
test('stop executing if context providers are not making progress', async () => {
    context_providers_1.registerContextProvider('testprovider', class {
        async getValue(_) {
            return 'foo';
        }
    });
    const stacks = new stacks_1.AppStacks({
        configuration: new settings_1.Configuration(),
        aws: new lib_1.SDK({ userAgent: 'aws-cdk/jest' }),
        synthesizer: async () => util_1.testAssembly({
            stacks: [{
                    stackName: 'thestack',
                    template: { resource: 'noerrorresource' },
                }],
            // Always return the same missing keys, synthesis should still finish.
            missing: [
                { key: 'abcdef', props: {}, provider: 'testprovider' }
            ]
        }),
    });
    // WHEN
    await stacks.selectStacks(['thestack'], { defaultBehavior: stacks_1.DefaultSelection.AllStacks });
    // THEN: the test finishes normally});
});
function testStacks({ env, versionReporting = true } = {}) {
    const configuration = new settings_1.Configuration();
    configuration.settings.set(['versionReporting'], versionReporting);
    return new stacks_1.AppStacks({
        configuration,
        aws: new lib_1.SDK({ userAgent: 'aws-cdk/jest' }),
        synthesizer: async () => util_1.testAssembly({
            stacks: [{
                    stackName: 'withouterrors',
                    env,
                    template: { resource: 'noerrorresource' },
                },
                {
                    stackName: 'witherrors',
                    env,
                    template: { resource: 'errorresource' },
                    metadata: {
                        '/resource': [
                            {
                                type: cxapi.ERROR_METADATA_KEY,
                                data: 'this is an error'
                            }
                        ]
                    },
                }]
        }),
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFja3MudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QyxtQ0FBZ0M7QUFDaEMsdURBQXlFO0FBQ3pFLG1FQUFzRTtBQUN0RSxpREFBbUQ7QUFDbkQsa0NBQXVDO0FBRXZDLElBQUksQ0FBQyxrREFBa0QsRUFBRSxLQUFLLElBQUksRUFBRTtJQUNsRSxRQUFRO0lBQ1IsTUFBTSxNQUFNLEdBQUcsVUFBVSxFQUFFLENBQUM7SUFFNUIsT0FBTztJQUNQLE1BQU0sUUFBUSxHQUFHLE1BQU0sTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxFQUFFO1FBQzVELGVBQWUsRUFBRSx5QkFBZ0IsQ0FBQyxTQUFTO0tBQzVDLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFakMsT0FBTztJQUNQLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ2hFLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLDJDQUEyQyxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQzNELFFBQVE7SUFDUixNQUFNLE1BQU0sR0FBRyxVQUFVLEVBQUUsQ0FBQztJQUU1QixPQUFPO0lBQ1AsTUFBTSxRQUFRLEdBQUcsTUFBTSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsWUFBWSxDQUFDLEVBQUU7UUFDekQsZUFBZSxFQUFFLHlCQUFnQixDQUFDLFNBQVM7S0FDNUMsQ0FBQyxDQUFDO0lBRUgsT0FBTztJQUNQLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3pFLENBQUMsQ0FBQyxDQUFD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SCxRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFO29CQUN2QyxRQUFRLEVBQUU7d0JBQ1IsV0FBVyxFQUFFOzRCQUNYO2dDQUNFLElBQUksRUFBRSxLQUFLLENBQUMsa0JBQWtCO2dDQUM5QixJQUFJLEVBQUUsa0JBQWtCOzZCQUN6Qjt5QkFDRjtxQkFDRjtpQkFDRixDQUFDO1NBQ0gsQ0FBQztLQUNILENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgU0RLIH0gZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IEFwcFN0YWNrcywgRGVmYXVsdFNlbGVjdGlvbiB9IGZyb20gJy4uLy4uL2xpYi9hcGkvY3hhcHAvc3RhY2tzJztcbmltcG9ydCB7IHJlZ2lzdGVyQ29udGV4dFByb3ZpZGVyIH0gZnJvbSAnLi4vLi4vbGliL2NvbnRleHQtcHJvdmlkZXJzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9saWIvc2V0dGluZ3MnO1xuaW1wb3J0IHsgdGVzdEFzc2VtYmx5IH0gZnJvbSAnLi4vdXRpbCc7XG5cbnRlc3QoJ2RvIG5vdCB0aHJvdyB3aGVuIHNlbGVjdGluZyBzdGFjayB3aXRob3V0IGVycm9ycycsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcygpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3Qgc2VsZWN0ZWQgPSBhd2FpdCBzdGFja3Muc2VsZWN0U3RhY2tzKFsnd2l0aG91dGVycm9ycyddLCB7XG4gICAgZGVmYXVsdEJlaGF2aW9yOiBEZWZhdWx0U2VsZWN0aW9uLkFsbFN0YWNrc1xuICB9KTtcbiAgc3RhY2tzLnByb2Nlc3NNZXRhZGF0YShzZWxlY3RlZCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3Qoc2VsZWN0ZWRbMF0udGVtcGxhdGUucmVzb3VyY2UpLnRvQmUoJ25vZXJyb3JyZXNvdXJjZScpO1xufSk7XG5cbnRlc3QoJ2RvIHRocm93IHdoZW4gc2VsZWN0aW5nIHN0YWNrIHdpdGggZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFja3MgPSB0ZXN0U3RhY2tzKCk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBzZWxlY3RlZCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoWyd3aXRoZXJyb3JzJ10sIHtcbiAgICBkZWZhdWx0QmVoYXZpb3I6IERlZmF1bHRTZWxlY3Rpb24uQWxsU3RhY2tzXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KCgpID0+IHN0YWNrcy5wcm9jZXNzTWV0YWRhdGEoc2VsZWN0ZWQpKS50b1Rocm93KC9Gb3VuZCBlcnJvcnMvKTtcbn0pO1xuXG50ZXN0KCdzZWxlY3QgYmVoYXZpb3I6IGFsbCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcygpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgeCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoW10sIHsgZGVmYXVsdEJlaGF2aW9yOiBEZWZhdWx0U2VsZWN0aW9uLkFsbFN0YWNrcyB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdCh4Lmxlbmd0aCkudG9CZSgyKTtcbn0pO1xuXG50ZXN0KCdzZWxlY3QgYmVoYXZpb3I6IG5vbmUnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHN0YWNrcyA9IHRlc3RTdGFja3MoKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHggPSBhd2FpdCBzdGFja3Muc2VsZWN0U3RhY2tzKFtdLCB7IGRlZmF1bHRCZWhhdmlvcjogRGVmYXVsdFNlbGVjdGlvbi5Ob25lIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHgubGVuZ3RoKS50b0JlKDApO1xufSk7XG5cbnRlc3QoJ3NlbGVjdCBiZWhhdmlvcjogc2luZ2xlJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFja3MgPSB0ZXN0U3RhY2tzKCk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBleHBlY3Qoc3RhY2tzLnNlbGVjdFN0YWNrcyhbXSwgeyBkZWZhdWx0QmVoYXZpb3I6IERlZmF1bHRTZWxlY3Rpb24uT25seVNpbmdsZSB9KSlcbiAgICAucmVqZWN0cy50b1Rocm93KCdTaW5jZSB0aGlzIGFwcCBpbmNsdWRlcyBtb3JlIHRoYW4gYSBzaW5nbGUgc3RhY2ssIHNwZWNpZnkgd2hpY2ggc3RhY2tzIHRvIHVzZSAod2lsZGNhcmRzIGFyZSBzdXBwb3J0ZWQpJyk7XG59KTtcblxuZGVzY3JpYmUoJ0FXUzo6Q0RLOjpNZXRhZGF0YScsICgpID0+IHtcbiAgdGVzdCgnaXMgZ2VuZXJhdGVkIGZvciByZWxvY2F0YWJsZSBzdGFja3MnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3RhY2tzID0gdGVzdFN0YWNrcyh7IGVudjogYGF3czovLyR7Y3hhcGkuVU5LTk9XTl9BQ0NPVU5UfS8ke2N4YXBpLlVOS05PV05fUkVHSU9OfWAsIHZlcnNpb25SZXBvcnRpbmc6IHRydWUgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzdGFja3Muc3ludGhlc2l6ZVN0YWNrKCd3aXRob3V0ZXJyb3JzJyk7XG4gICAgY29uc3QgbWV0YWRhdGEgPSByZXN1bHQudGVtcGxhdGUuUmVzb3VyY2VzICYmIHJlc3VsdC50ZW1wbGF0ZS5SZXNvdXJjZXMuQ0RLTWV0YWRhdGE7XG4gICAgZXhwZWN0KG1ldGFkYXRhKS50b0VxdWFsKHtcbiAgICAgIFR5cGU6ICdBV1M6OkNESzo6TWV0YWRhdGEnLFxuICAgICAgUHJvcGVydGllczoge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuICAgICAgICBNb2R1bGVzOiBgJHtyZXF1aXJlKCcuLi8uLi9wYWNrYWdlLmpzb24nKS5uYW1lfT0ke3JlcXVpcmUoJy4uLy4uL3BhY2thZ2UuanNvbicpLnZlcnNpb259YFxuICAgICAgfSxcbiAgICAgIENvbmRpdGlvbjogJ0NES01ldGFkYXRhQXZhaWxhYmxlJyxcbiAgICB9KTtcblxuICAgIGV4cGVjdChyZXN1bHQudGVtcGxhdGUuQ29uZGl0aW9ucz8uQ0RLTWV0YWRhdGFBdmFpbGFibGUpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2lzIGdlbmVyYXRlZCBmb3Igc3RhY2tzIGluIHN1cHBvcnRlZCByZWdpb25zJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHN0YWNrcyA9IHRlc3RTdGFja3MoeyBlbnY6ICdhd3M6Ly8wMTIzNDU2Nzg5MTIvdXMtZWFzdC0xJywgdmVyc2lvblJlcG9ydGluZzogdHJ1ZSB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN0YWNrcy5zeW50aGVzaXplU3RhY2soJ3dpdGhvdXRlcnJvcnMnKTtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHJlc3VsdC50ZW1wbGF0ZS5SZXNvdXJjZXMgJiYgcmVzdWx0LnRlbXBsYXRlLlJlc291cmNlcy5DREtNZXRhZGF0YTtcbiAgICBleHBlY3QobWV0YWRhdGEpLnRvRXF1YWwoe1xuICAgICAgVHlwZTogJ0FXUzo6Q0RLOjpNZXRhZGF0YScsXG4gICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tcmVxdWlyZS1pbXBvcnRzXG4gICAgICAgIE1vZHVsZXM6IGAke3JlcXVpcmUoJy4uLy4uL3BhY2thZ2UuanNvbicpLm5hbWV9PSR7cmVxdWlyZSgnLi4vLi4vcGFja2FnZS5qc29uJykudmVyc2lvbn1gXG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2lzIG5vdCBnZW5lcmF0ZWQgZm9yIHN0YWNrcyBpbiB1bnN1cHBvcnRlZCByZWdpb25zJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHN0YWNrcyA9IHRlc3RTdGFja3MoeyBlbnY6ICdhd3M6Ly8wMTIzNDU2Nzg5MTIvYmVybXVkYS10cmlhbmdsZS0xMzM3JywgdmVyc2lvblJlcG9ydGluZzogdHJ1ZSB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN0YWNrcy5zeW50aGVzaXplU3RhY2soJ3dpdGhvdXRlcnJvcnMnKTtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHJlc3VsdC50ZW1wbGF0ZS5SZXNvdXJjZXMgJiYgcmVzdWx0LnRlbXBsYXRlLlJlc291cmNlcy5DREtNZXRhZGF0YTtcbiAgICBleHBlY3QobWV0YWRhdGEpLnRvQmVVbmRlZmluZWQoKTtcbiAgfSk7XG59KTtcblxudGVzdCgnc3RvcCBleGVjdXRpbmcgaWYgY29udGV4dCBwcm92aWRlcnMgYXJlIG5vdCBtYWtpbmcgcHJvZ3Jlc3MnLCBhc3luYyAoKSA9PiB7XG4gIHJlZ2lzdGVyQ29udGV4dFByb3ZpZGVyKCd0ZXN0cHJvdmlkZXInLCBjbGFzcyB7XG4gICAgcHVibGljIGFzeW5jIGdldFZhbHVlKF86IHsgW2tleTogc3RyaW5nXTogYW55IH0pOiBQcm9taXNlPGFueT4ge1xuICAgICAgcmV0dXJuICdmb28nO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3Qgc3RhY2tzID0gbmV3IEFwcFN0YWNrcyh7XG4gICAgY29uZmlndXJhdGlvbjogbmV3IENvbmZpZ3VyYXRpb24oKSxcbiAgICBhd3M6IG5ldyBTREsoeyB1c2VyQWdlbnQ6ICdhd3MtY2RrL2plc3QnIH0pLFxuICAgIHN5bnRoZXNpemVyOiBhc3luYyAoKSA9PiB0ZXN0QXNzZW1ibHkoe1xuICAgICAgc3RhY2tzOiBbe1xuICAgICAgICBzdGFja05hbWU6ICd0aGVzdGFjaycsXG4gICAgICAgIHRlbXBsYXRlOiB7IHJlc291cmNlOiAnbm9lcnJvcnJlc291cmNlJyB9LFxuICAgICAgfV0sXG4gICAgICAvLyBBbHdheXMgcmV0dXJuIHRoZSBzYW1lIG1pc3Npbmcga2V5cywgc3ludGhlc2lzIHNob3VsZCBzdGlsbCBmaW5pc2guXG4gICAgICBtaXNzaW5nOiBbXG4gICAgICAgIHsga2V5OiAnYWJjZGVmJywgcHJvcHM6IHt9LCBwcm92aWRlcjogJ3Rlc3Rwcm92aWRlcicgfVxuICAgICAgXVxuICAgIH0pLFxuICB9KTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoWyd0aGVzdGFjayddLCB7IGRlZmF1bHRCZWhhdmlvcjogRGVmYXVsdFNlbGVjdGlvbi5BbGxTdGFja3MgfSk7XG5cbiAgLy8gVEhFTjogdGhlIHRlc3QgZmluaXNoZXMgbm9ybWFsbHl9KTtcbn0pO1xuXG5mdW5jdGlvbiB0ZXN0U3RhY2tzKHsgZW52LCB2ZXJzaW9uUmVwb3J0aW5nID0gdHJ1ZSB9OiB7IGVudj86IHN0cmluZywgdmVyc2lvblJlcG9ydGluZz86IGJvb2xlYW4gfSA9IHt9KSB7XG4gIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSBuZXcgQ29uZmlndXJhdGlvbigpO1xuICBjb25maWd1cmF0aW9uLnNldHRpbmdzLnNldChbJ3ZlcnNpb25SZXBvcnRpbmcnXSwgdmVyc2lvblJlcG9ydGluZyk7XG5cbiAgcmV0dXJuIG5ldyBBcHBTdGFja3Moe1xuICAgIGNvbmZpZ3VyYXRpb24sXG4gICAgYXdzOiBuZXcgU0RLKHsgdXNlckFnZW50OiAnYXdzLWNkay9qZXN0JyB9KSxcbiAgICBzeW50aGVzaXplcjogYXN5bmMgKCkgPT4gdGVzdEFzc2VtYmx5KHtcbiAgICAgIHN0YWNrczogW3tcbiAgICAgICAgc3RhY2tOYW1lOiAnd2l0aG91dGVycm9ycycsXG4gICAgICAgIGVudixcbiAgICAgICAgdGVtcGxhdGU6IHsgcmVzb3VyY2U6ICdub2Vycm9ycmVzb3VyY2UnIH0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBzdGFja05hbWU6ICd3aXRoZXJyb3JzJyxcbiAgICAgICAgZW52LFxuICAgICAgICB0ZW1wbGF0ZTogeyByZXNvdXJjZTogJ2Vycm9ycmVzb3VyY2UnIH0sXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgJy9yZXNvdXJjZSc6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgdHlwZTogY3hhcGkuRVJST1JfTUVUQURBVEFfS0VZLFxuICAgICAgICAgICAgICBkYXRhOiAndGhpcyBpcyBhbiBlcnJvcidcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH0sXG4gICAgICB9XVxuICAgIH0pLFxuICB9KTtcbn1cbiJdfQ==