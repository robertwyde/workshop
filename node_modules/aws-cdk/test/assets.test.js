"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assets_1 = require("../lib/assets");
const util_1 = require("./util");
test('prepare assets', async () => {
    // GIVEN
    const assembly = util_1.testAssembly({
        stacks: [{
                stackName: 'SomeStack',
                template: {
                    Resources: {
                        SomeResource: {
                            Type: 'AWS::Something::Something'
                        }
                    }
                },
                assets: [
                    {
                        sourceHash: 'source-hash',
                        path: __filename,
                        id: 'SomeStackSomeResource4567',
                        packaging: 'file',
                        s3BucketParameter: 'BucketParameter',
                        s3KeyParameter: 'KeyParameter',
                        artifactHashParameter: 'ArtifactHashParameter',
                    }
                ]
            }]
    });
    const toolkit = new FakeToolkit();
    // WHEN
    const params = await assets_1.prepareAssets(assembly.getStackByName('SomeStack'), toolkit);
    // THEN
    expect(params).toEqual([
        { ParameterKey: 'BucketParameter', ParameterValue: 'bucket' },
        { ParameterKey: 'KeyParameter', ParameterValue: 'assets/SomeStackSomeResource4567/||12345.ts' },
        { ParameterKey: 'ArtifactHashParameter', ParameterValue: '12345' },
    ]);
});
test('prepare assets with reuse', async () => {
    // GIVEN
    const stack = util_1.testStack({
        stackName: 'SomeStack',
        assets: [
            {
                path: __filename,
                id: 'SomeStackSomeResource4567',
                packaging: 'file',
                s3BucketParameter: 'BucketParameter',
                s3KeyParameter: 'KeyParameter',
                artifactHashParameter: 'ArtifactHashParameter',
                sourceHash: 'boom'
            }
        ],
        template: {
            Resources: {
                SomeResource: {
                    Type: 'AWS::Something::Something'
                }
            }
        }
    });
    const toolkit = new FakeToolkit();
    // WHEN
    const params = await assets_1.prepareAssets(stack, toolkit, ['SomeStackSomeResource4567']);
    // THEN
    expect(params).toEqual([
        { ParameterKey: 'BucketParameter', UsePreviousValue: true },
        { ParameterKey: 'KeyParameter', UsePreviousValue: true },
        { ParameterKey: 'ArtifactHashParameter', UsePreviousValue: true },
    ]);
});
test('prepare container asset with reuse', async () => {
    // GIVEN
    const stack = util_1.testStack({
        stackName: 'SomeStack',
        assets: [
            {
                path: __dirname,
                id: 'SomeStackSomeResource4567',
                packaging: 'container-image',
                imageNameParameter: 'asdf',
                sourceHash: 'source-hash'
            }
        ],
        template: {
            Resources: {
                SomeResource: {
                    Type: 'AWS::Something::Something'
                }
            }
        }
    });
    const toolkit = new FakeToolkit();
    // WHEN
    const params = await assets_1.prepareAssets(stack, toolkit, ['SomeStackSomeResource4567']);
    // THEN
    expect(params).toEqual([
        { ParameterKey: 'asdf', UsePreviousValue: true },
    ]);
});
class FakeToolkit {
    constructor() {
        this.bucketUrl = 'https://bucket';
        this.bucketName = 'bucket';
    }
    async uploadIfChanged(_data, props) {
        const filename = `12345${props.s3KeySuffix}`;
        return {
            filename,
            key: `${props.s3KeyPrefix}${filename}`,
            hash: '12345',
            changed: true,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhc3NldHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDBDQUE4QztBQUM5QyxpQ0FBaUQ7QUFFakQsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ2hDLFFBQVE7SUFDUixNQUFNLFFBQVEsR0FBRyxtQkFBWSxDQUFDO1FBQzVCLE1BQU0sRUFBRSxDQUFDO2dCQUNQLFNBQVMsRUFBRSxXQUFXO2dCQUN0QixRQUFRLEVBQUU7b0JBQ1IsU0FBUyxFQUFFO3dCQUNULFlBQVksRUFBRTs0QkFDWixJQUFJLEVBQUUsMkJBQTJCO3lCQUNsQztxQkFDRjtpQkFDRjtnQkFDRCxNQUFNLEVBQUU7b0JBQ047d0JBQ0UsVUFBVSxFQUFFLGFBQWE7d0JBQ3pCLElBQUksRUFBRSxVQUFVO3dCQUNoQixFQUFFLEVBQUUsMkJBQTJCO3dCQUMvQixTQUFTLEVBQUUsTUFBTTt3QkFDakIsaUJBQWlCLEVBQUUsaUJBQWlCO3dCQUNwQyxjQUFjLEVBQUUsY0FBYzt3QkFDOUIscUJBQXFCLEVBQUUsdUJBQXVCO3FCQUMvQztpQkFDRjthQUNGLENBQUM7S0FDSCxDQUFDLENBQUM7SUFFSCxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBRWxDLE9BQU87SUFDUCxNQUFNLE1BQU0sR0FBRyxNQUFNLHNCQUFhLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsRUFBRSxPQUFjLENBQUMsQ0FBQztJQUV6RixPQUFPO0lBQ1AsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNyQixFQUFFLFlBQVksRUFBRSxpQkFBaUIsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFO1FBQzdELEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsNkNBQTZDLEVBQUU7UUFDL0YsRUFBRSxZQUFZLEVBQUUsdUJBQXVCLEVBQUUsY0FBYyxFQUFFLE9BQU8sRUFBRTtLQUNuRSxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQywyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRTtJQUMzQyxRQUFRO0lBQ1IsTUFBTSxLQUFLLEdBQUcsZ0JBQVMsQ0FBQztRQUN0QixTQUFTLEVBQUUsV0FBVztRQUN0QixNQUFNLEVBQUU7WUFDTjtnQkFDRSxJQUFJLEVBQUUsVUFBVTtnQkFDaEIsRUFBRSxFQUFFLDJCQUEyQjtnQkFDL0IsU0FBUyxFQUFFLE1BQU07Z0JBQ2pCLGlCQUFpQixFQUFFLGlCQUFpQjtnQkFDcEMsY0FBYyxFQUFFLGNBQWM7Z0JBQzlCLHFCQUFxQixFQUFFLHVCQUF1QjtnQkFDOUMsVUFBVSxFQUFFLE1BQU07YUFDbkI7U0FDRjtRQUNELFFBQVEsRUFBRTtZQUNSLFNBQVMsRUFBRTtnQkFDVCxZQUFZLEVBQUU7b0JBQ1osSUFBSSxFQUFFLDJCQUEyQjtpQkFDbEM7YUFDRjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUVsQyxPQUFPO0lBQ1AsTUFBTSxNQUFNLEdBQUcsTUFBTSxzQkFBYSxDQUFDLEtBQUssRUFBRSxPQUFjLEVBQUUsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLENBQUM7SUFFekYsT0FBTztJQUNQLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDckIsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFO1FBQzNELEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUU7UUFDeEQsRUFBRSxZQUFZLEVBQUUsdUJBQXVCLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFO0tBQ2xFLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLG9DQUFvQyxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ3BELFFBQVE7SUFDUixNQUFNLEtBQUssR0FBRyxnQkFBUyxDQUFDO1FBQ3RCLFNBQVMsRUFBRSxXQUFXO1FBQ3RCLE1BQU0sRUFBRTtZQUNOO2dCQUNFLElBQUksRUFBRSxTQUFTO2dCQUNmLEVBQUUsRUFBRSwyQkFBMkI7Z0JBQy9CLFNBQVMsRUFBRSxpQkFBaUI7Z0JBQzVCLGtCQUFrQixFQUFFLE1BQU07Z0JBQzFCLFVBQVUsRUFBRSxhQUFhO2FBQzFCO1NBQ0Y7UUFDRCxRQUFRLEVBQUU7WUFDUixTQUFTLEVBQUU7Z0JBQ1QsWUFBWSxFQUFFO29CQUNaLElBQUksRUFBRSwyQkFBMkI7aUJBQ2xDO2FBQ0Y7U0FDRjtLQUNGLENBQUMsQ0FBQztJQUNILE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7SUFFbEMsT0FBTztJQUNQLE1BQU0sTUFBTSxHQUFHLE1BQU0sc0JBQWEsQ0FBQyxLQUFLLEVBQUUsT0FBYyxFQUFFLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxDQUFDO0lBRXpGLE9BQU87SUFDUCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ3JCLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUU7S0FDakQsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLFdBQVc7SUFBakI7UUFDUyxjQUFTLEdBQVcsZ0JBQWdCLENBQUM7UUFDckMsZUFBVSxHQUFXLFFBQVEsQ0FBQztJQVd2QyxDQUFDO0lBVFEsS0FBSyxDQUFDLGVBQWUsQ0FBQyxLQUFVLEVBQUUsS0FBa0I7UUFDekQsTUFBTSxRQUFRLEdBQUcsUUFBUSxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDN0MsT0FBTztZQUNMLFFBQVE7WUFDUixHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsV0FBVyxHQUFHLFFBQVEsRUFBRTtZQUN0QyxJQUFJLEVBQUUsT0FBTztZQUNiLE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVwbG9hZGVkLCBVcGxvYWRQcm9wcyB9IGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBwcmVwYXJlQXNzZXRzIH0gZnJvbSAnLi4vbGliL2Fzc2V0cyc7XG5pbXBvcnQgeyB0ZXN0QXNzZW1ibHksIHRlc3RTdGFjayB9IGZyb20gJy4vdXRpbCc7XG5cbnRlc3QoJ3ByZXBhcmUgYXNzZXRzJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBhc3NlbWJseSA9IHRlc3RBc3NlbWJseSh7XG4gICAgc3RhY2tzOiBbe1xuICAgICAgc3RhY2tOYW1lOiAnU29tZVN0YWNrJyxcbiAgICAgIHRlbXBsYXRlOiB7XG4gICAgICAgIFJlc291cmNlczoge1xuICAgICAgICAgIFNvbWVSZXNvdXJjZToge1xuICAgICAgICAgICAgVHlwZTogJ0FXUzo6U29tZXRoaW5nOjpTb21ldGhpbmcnXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgYXNzZXRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBzb3VyY2VIYXNoOiAnc291cmNlLWhhc2gnLFxuICAgICAgICAgIHBhdGg6IF9fZmlsZW5hbWUsXG4gICAgICAgICAgaWQ6ICdTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3JyxcbiAgICAgICAgICBwYWNrYWdpbmc6ICdmaWxlJyxcbiAgICAgICAgICBzM0J1Y2tldFBhcmFtZXRlcjogJ0J1Y2tldFBhcmFtZXRlcicsXG4gICAgICAgICAgczNLZXlQYXJhbWV0ZXI6ICdLZXlQYXJhbWV0ZXInLFxuICAgICAgICAgIGFydGlmYWN0SGFzaFBhcmFtZXRlcjogJ0FydGlmYWN0SGFzaFBhcmFtZXRlcicsXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9XVxuICB9KTtcblxuICBjb25zdCB0b29sa2l0ID0gbmV3IEZha2VUb29sa2l0KCk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBwYXJhbXMgPSBhd2FpdCBwcmVwYXJlQXNzZXRzKGFzc2VtYmx5LmdldFN0YWNrQnlOYW1lKCdTb21lU3RhY2snKSwgdG9vbGtpdCBhcyBhbnkpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBhcmFtcykudG9FcXVhbChbXG4gICAgeyBQYXJhbWV0ZXJLZXk6ICdCdWNrZXRQYXJhbWV0ZXInLCBQYXJhbWV0ZXJWYWx1ZTogJ2J1Y2tldCcgfSxcbiAgICB7IFBhcmFtZXRlcktleTogJ0tleVBhcmFtZXRlcicsIFBhcmFtZXRlclZhbHVlOiAnYXNzZXRzL1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcvfHwxMjM0NS50cycgfSxcbiAgICB7IFBhcmFtZXRlcktleTogJ0FydGlmYWN0SGFzaFBhcmFtZXRlcicsIFBhcmFtZXRlclZhbHVlOiAnMTIzNDUnIH0sXG4gIF0pO1xufSk7XG5cbnRlc3QoJ3ByZXBhcmUgYXNzZXRzIHdpdGggcmV1c2UnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHN0YWNrID0gdGVzdFN0YWNrKHtcbiAgICBzdGFja05hbWU6ICdTb21lU3RhY2snLFxuICAgIGFzc2V0czogW1xuICAgICAge1xuICAgICAgICBwYXRoOiBfX2ZpbGVuYW1lLFxuICAgICAgICBpZDogJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnLFxuICAgICAgICBwYWNrYWdpbmc6ICdmaWxlJyxcbiAgICAgICAgczNCdWNrZXRQYXJhbWV0ZXI6ICdCdWNrZXRQYXJhbWV0ZXInLFxuICAgICAgICBzM0tleVBhcmFtZXRlcjogJ0tleVBhcmFtZXRlcicsXG4gICAgICAgIGFydGlmYWN0SGFzaFBhcmFtZXRlcjogJ0FydGlmYWN0SGFzaFBhcmFtZXRlcicsXG4gICAgICAgIHNvdXJjZUhhc2g6ICdib29tJ1xuICAgICAgfVxuICAgIF0sXG4gICAgdGVtcGxhdGU6IHtcbiAgICAgIFJlc291cmNlczoge1xuICAgICAgICBTb21lUmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTb21ldGhpbmc6OlNvbWV0aGluZydcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGNvbnN0IHRvb2xraXQgPSBuZXcgRmFrZVRvb2xraXQoKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHBhcmFtcyA9IGF3YWl0IHByZXBhcmVBc3NldHMoc3RhY2ssIHRvb2xraXQgYXMgYW55LCBbJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnXSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGFyYW1zKS50b0VxdWFsKFtcbiAgICB7IFBhcmFtZXRlcktleTogJ0J1Y2tldFBhcmFtZXRlcicsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICB7IFBhcmFtZXRlcktleTogJ0tleVBhcmFtZXRlcicsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICB7IFBhcmFtZXRlcktleTogJ0FydGlmYWN0SGFzaFBhcmFtZXRlcicsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgXSk7XG59KTtcblxudGVzdCgncHJlcGFyZSBjb250YWluZXIgYXNzZXQgd2l0aCByZXVzZScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSB0ZXN0U3RhY2soe1xuICAgIHN0YWNrTmFtZTogJ1NvbWVTdGFjaycsXG4gICAgYXNzZXRzOiBbXG4gICAgICB7XG4gICAgICAgIHBhdGg6IF9fZGlybmFtZSxcbiAgICAgICAgaWQ6ICdTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3JyxcbiAgICAgICAgcGFja2FnaW5nOiAnY29udGFpbmVyLWltYWdlJyxcbiAgICAgICAgaW1hZ2VOYW1lUGFyYW1ldGVyOiAnYXNkZicsXG4gICAgICAgIHNvdXJjZUhhc2g6ICdzb3VyY2UtaGFzaCdcbiAgICAgIH1cbiAgICBdLFxuICAgIHRlbXBsYXRlOiB7XG4gICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgU29tZVJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6U29tZXRoaW5nOjpTb21ldGhpbmcnXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICBjb25zdCB0b29sa2l0ID0gbmV3IEZha2VUb29sa2l0KCk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBwYXJhbXMgPSBhd2FpdCBwcmVwYXJlQXNzZXRzKHN0YWNrLCB0b29sa2l0IGFzIGFueSwgWydTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3J10pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBhcmFtcykudG9FcXVhbChbXG4gICAgeyBQYXJhbWV0ZXJLZXk6ICdhc2RmJywgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICBdKTtcbn0pO1xuXG5jbGFzcyBGYWtlVG9vbGtpdCB7XG4gIHB1YmxpYyBidWNrZXRVcmw6IHN0cmluZyA9ICdodHRwczovL2J1Y2tldCc7XG4gIHB1YmxpYyBidWNrZXROYW1lOiBzdHJpbmcgPSAnYnVja2V0JztcblxuICBwdWJsaWMgYXN5bmMgdXBsb2FkSWZDaGFuZ2VkKF9kYXRhOiBhbnksIHByb3BzOiBVcGxvYWRQcm9wcyk6IFByb21pc2U8VXBsb2FkZWQ+IHtcbiAgICBjb25zdCBmaWxlbmFtZSA9IGAxMjM0NSR7cHJvcHMuczNLZXlTdWZmaXh9YDtcbiAgICByZXR1cm4ge1xuICAgICAgZmlsZW5hbWUsXG4gICAgICBrZXk6IGAke3Byb3BzLnMzS2V5UHJlZml4fSR7ZmlsZW5hbWV9YCxcbiAgICAgIGhhc2g6ICcxMjM0NScsXG4gICAgICBjaGFuZ2VkOiB0cnVlLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==