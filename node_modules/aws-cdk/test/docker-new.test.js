"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const sinon = require("sinon");
const lib_1 = require("../lib");
const docker_1 = require("../lib/docker");
const os = require("../lib/os");
const mock_sdk_1 = require("./util/mock-sdk");
test('fails if "repositoryName" and "imageTag" are not specified', async () => {
    // GIVEN
    const toolkit = newMockToolkitInfo();
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '0123456789abcdef',
    };
    // THEN
    await expect(docker_1.prepareContainerAsset('.', asset, toolkit, false))
        .rejects.toEqual(new Error(`invalid docker image asset configuration\. "repositoryName" and "imageTag" are required and "imageNameParameter" is not allowed`));
});
test('fails if "repositoryName" is not specified', async () => {
    // GIVEN
    const toolkit = newMockToolkitInfo();
    // WHEN
    const asset = {
        id: 'assetId',
        repositoryName: 'repository-name',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '0123456789abcdef',
    };
    // THEN
    await expect(docker_1.prepareContainerAsset('.', asset, toolkit, false))
        .rejects.toEqual(new Error(`invalid docker image asset configuration\. "repositoryName" and "imageTag" are required and "imageNameParameter" is not allowed`));
});
test('creates repository with given name', async () => {
    // GIVEN
    const sdk = new mock_sdk_1.MockSDK();
    const toolkit = newMockToolkitInfo(sdk);
    let createdName;
    sdk.stubEcr({
        describeRepositories: () => ({ repositories: [] }),
        createRepository: req => {
            createdName = req.repositoryName;
            // Stop the test so that we don't actually docker build
            throw new Error('STOPTEST');
        },
    });
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: '/foo',
        repositoryName: 'some-name',
        imageTag: 'image-tag',
        sourceHash: '0123456789abcdef',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    expect(createdName).toBe('some-name');
});
test('configures image scanning', async () => {
    // GIVEN
    let putImageScanningConfigurationParams;
    const sdk = new mock_sdk_1.MockSDK();
    sdk.stubEcr({
        describeRepositories: () => ({ repositories: [] }),
        createRepository: () => ({ repository: { repositoryUri: 'uri' } }),
        putImageScanningConfiguration: params => {
            putImageScanningConfigurationParams = params;
            // Stop the test so that we don't actually docker build
            throw new Error('STOPTEST');
        }
    });
    const toolkit = newMockToolkitInfo(sdk);
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: '/foo',
        repositoryName: 'some-name',
        imageTag: 'some-tag',
        sourceHash: '0123456789abcdef',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    expect(putImageScanningConfigurationParams).toEqual({
        repositoryName: 'some-name',
        imageScanningConfiguration: {
            scanOnPush: true
        }
    });
});
test('passes the correct target to docker build', async () => {
    // GIVEN
    const toolkit = newMockToolkitInfo();
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({ repositoryUri: 'uri' });
    const checkEcrImageStub = sinon.stub(toolkit, 'checkEcrImage').resolves(false);
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        imageTag: 'some-tag',
        buildArgs: {
            a: 'b',
            c: 'd'
        },
        target: 'a-target',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--tag', `uri:some-tag`, '--target', 'a-target', '--build-arg', 'a=b', '--build-arg', 'c=d', '/foo'];
    sinon.assert.calledWith(shellStub, command);
    prepareEcrRepositoryStub.restore();
    shellStub.restore();
    checkEcrImageStub.restore();
});
test('passes the correct args to docker build', async () => {
    // GIVEN
    const toolkit = newMockToolkitInfo();
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({ repositoryUri: 'uri' });
    const checkEcrImageStub = sinon.stub(toolkit, 'checkEcrImage').resolves(false);
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        imageTag: 'some-tag',
        buildArgs: {
            a: 'b',
            c: 'd'
        }
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--tag', `uri:some-tag`, '--build-arg', 'a=b', '--build-arg', 'c=d', '/foo'];
    sinon.assert.calledWith(shellStub, command);
    prepareEcrRepositoryStub.restore();
    checkEcrImageStub.restore();
    shellStub.restore();
});
test('passes the correct docker file name if specified', async () => {
    const toolkit = newMockToolkitInfo();
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({ repositoryUri: 'uri' });
    const checkEcrImageStub = sinon.stub(toolkit, 'checkEcrImage').resolves(false);
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        imageTag: 'some-tag',
        file: 'CustomDockerfile',
        buildArgs: {
            a: 'b',
            c: 'd'
        }
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--tag', `uri:some-tag`, '--file', '/foo/CustomDockerfile', '--build-arg', 'a=b', '--build-arg', 'c=d', '/foo'];
    sinon.assert.calledWith(shellStub, command);
    prepareEcrRepositoryStub.restore();
    checkEcrImageStub.restore();
    shellStub.restore();
});
test('relative path', async () => {
    // GIVEN
    const toolkit = newMockToolkitInfo();
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({ repositoryUri: 'uri' });
    const checkEcrImageStub = sinon.stub(toolkit, 'checkEcrImage').resolves(false);
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: 'relative-to-assembly',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        imageTag: 'some-tag',
        buildArgs: {
            a: 'b',
            c: 'd'
        }
    };
    try {
        await docker_1.prepareContainerAsset('/assembly/dir/root', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--tag', `uri:some-tag`, '--build-arg', 'a=b', '--build-arg', 'c=d', '/assembly/dir/root/relative-to-assembly'];
    sinon.assert.calledWith(shellStub, command);
    prepareEcrRepositoryStub.restore();
    checkEcrImageStub.restore();
    shellStub.restore();
});
test('skips build & push if image already exists in the ECR repo', async () => {
    // GIVEN
    const toolkit = newMockToolkitInfo();
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository');
    const shellStub = sinon.stub(os, 'shell');
    const checkEcrImageStub = sinon.stub(toolkit, 'checkEcrImage').resolves(true);
    // WHEN
    const asset = {
        id: 'assetId',
        packaging: 'container-image',
        path: 'relative-to-assembly',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        imageTag: 'some-tag',
        buildArgs: {
            a: 'b',
            c: 'd'
        }
    };
    await docker_1.prepareContainerAsset('/assembly/dir/root', asset, toolkit, false);
    // THEN
    sinon.assert.calledOnce(prepareEcrRepositoryStub);
    sinon.assert.calledOnce(checkEcrImageStub);
    sinon.assert.notCalled(shellStub);
});
function newMockToolkitInfo(sdk = new mock_sdk_1.MockSDK()) {
    return new lib_1.ToolkitInfo({
        sdk,
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLW5ldy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLW5ldy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsK0JBQStCO0FBQy9CLGdDQUFxQztBQUNyQywwQ0FBc0Q7QUFDdEQsZ0NBQWdDO0FBQ2hDLDhDQUEwQztBQUUxQyxJQUFJLENBQUMsNERBQTRELEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDNUUsUUFBUTtJQUNSLE1BQU0sT0FBTyxHQUFHLGtCQUFrQixFQUFFLENBQUM7SUFFckMsT0FBTztJQUNQLE1BQU0sS0FBSyxHQUEyQztRQUNwRCxFQUFFLEVBQUUsU0FBUztRQUNiLFNBQVMsRUFBRSxpQkFBaUI7UUFDNUIsSUFBSSxFQUFFLE1BQU07UUFDWixVQUFVLEVBQUUsa0JBQWtCO0tBQy9CLENBQUM7SUFFRixPQUFPO0lBQ1AsTUFBTSxNQUFNLENBQUMsOEJBQXFCLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDNUQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssQ0FBQyxpSUFBaUksQ0FBQyxDQUFDLENBQUM7QUFDbkssQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsNENBQTRDLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDNUQsUUFBUTtJQUNSLE1BQU0sT0FBTyxHQUFHLGtCQUFrQixFQUFFLENBQUM7SUFFckMsT0FBTztJQUNQLE1BQU0sS0FBSyxHQUEyQztRQUNwRCxFQUFFLEVBQUUsU0FBUztRQUNiLGNBQWMsRUFBRSxpQkFBaUI7UUFDakMsU0FBUyxFQUFFLGlCQUFpQjtRQUM1QixJQUFJLEVBQUUsTUFBTTtRQUNaLFVBQVUsRUFBRSxrQkFBa0I7S0FDL0IsQ0FBQztJQUVGLE9BQU87SUFDUCxNQUFNLE1BQU0sQ0FBQyw4QkFBcUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztT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QUMsd0JBQXdCLENBQUMsQ0FBQztJQUNsRCxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQzNDLEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3BDLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxrQkFBa0IsQ0FBQyxNQUFlLElBQUksa0JBQU8sRUFBRTtJQUN0RCxPQUFPLElBQUksaUJBQVcsQ0FBQztRQUNyQixHQUFHO1FBQ0gsVUFBVSxFQUFFLGFBQWE7UUFDekIsY0FBYyxFQUFFLGlCQUFpQjtRQUNqQyxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtLQUM3RCxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY3hhcGkgZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCAqIGFzIHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCB7IFRvb2xraXRJbmZvIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IHByZXBhcmVDb250YWluZXJBc3NldCB9IGZyb20gJy4uL2xpYi9kb2NrZXInO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnLi4vbGliL29zJztcbmltcG9ydCB7IE1vY2tTREsgfSBmcm9tICcuL3V0aWwvbW9jay1zZGsnO1xuXG50ZXN0KCdmYWlscyBpZiBcInJlcG9zaXRvcnlOYW1lXCIgYW5kIFwiaW1hZ2VUYWdcIiBhcmUgbm90IHNwZWNpZmllZCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3QgdG9vbGtpdCA9IG5ld01vY2tUb29sa2l0SW5mbygpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgYXNzZXQ6IGN4YXBpLkNvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5ID0ge1xuICAgIGlkOiAnYXNzZXRJZCcsXG4gICAgcGFja2FnaW5nOiAnY29udGFpbmVyLWltYWdlJyxcbiAgICBwYXRoOiAnL2ZvbycsXG4gICAgc291cmNlSGFzaDogJzAxMjM0NTY3ODlhYmNkZWYnLFxuICB9O1xuXG4gIC8vIFRIRU5cbiAgYXdhaXQgZXhwZWN0KHByZXBhcmVDb250YWluZXJBc3NldCgnLicsIGFzc2V0LCB0b29sa2l0LCBmYWxzZSkpXG4gICAgLnJlamVjdHMudG9FcXVhbChuZXcgRXJyb3IoYGludmFsaWQgZG9ja2VyIGltYWdlIGFzc2V0IGNvbmZpZ3VyYXRpb25cXC4gXCJyZXBvc2l0b3J5TmFtZVwiIGFuZCBcImltYWdlVGFnXCIgYXJlIHJlcXVpcmVkIGFuZCBcImltYWdlTmFtZVBhcmFtZXRlclwiIGlzIG5vdCBhbGxvd2VkYCkpO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGlmIFwicmVwb3NpdG9yeU5hbWVcIiBpcyBub3Qgc3BlY2lmaWVkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCB0b29sa2l0ID0gbmV3TW9ja1Rvb2xraXRJbmZvKCk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBhc3NldDogY3hhcGkuQ29udGFpbmVySW1hZ2VBc3NldE1ldGFkYXRhRW50cnkgPSB7XG4gICAgaWQ6ICdhc3NldElkJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3JlcG9zaXRvcnktbmFtZScsXG4gICAgcGFja2FnaW5nOiAnY29udGFpbmVyLWltYWdlJyxcbiAgICBwYXRoOiAnL2ZvbycsXG4gICAgc291cmNlSGFzaDogJzAxMjM0NTY3ODlhYmNkZWYnLFxuICB9O1xuXG4gIC8vIFRIRU5cbiAgYXdhaXQgZXhwZWN0KHByZXBhcmVDb250YWluZXJBc3NldCgnLicsIGFzc2V0LCB0b29sa2l0LCBmYWxzZSkpXG4gICAgLnJlamVjdHMudG9FcXVhbChuZXcgRXJyb3IoYGludmFsaWQgZG9ja2VyIGltYWdlIGFzc2V0IGNvbmZpZ3VyYXRpb25cXC4gXCJyZXBvc2l0b3J5TmFtZVwiIGFuZCBcImltYWdlVGFnXCIgYXJlIHJlcXVpcmVkIGFuZCBcImltYWdlTmFtZVBhcmFtZXRlclwiIGlzIG5vdCBhbGxvd2VkYCkpO1xufSk7XG5cbnRlc3QoJ2NyZWF0ZXMgcmVwb3NpdG9yeSB3aXRoIGdpdmVuIG5hbWUnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG4gIGNvbnN0IHRvb2xraXQgPSBuZXdNb2NrVG9vbGtpdEluZm8oc2RrKTtcbiAgbGV0IGNyZWF0ZWROYW1lO1xuXG4gIHNkay5zdHViRWNyKHtcbiAgICBkZXNjcmliZVJlcG9zaXRvcmllczogKCkgPT4gKHsgcmVwb3NpdG9yaWVzOiBbXSB9KSxcbiAgICBjcmVhdGVSZXBvc2l0b3J5OiByZXEgPT4ge1xuICAgICAgY3JlYXRlZE5hbWUgPSByZXEucmVwb3NpdG9yeU5hbWU7XG5cbiAgICAgIC8vIFN0b3AgdGhlIHRlc3Qgc28gdGhhdCB3ZSBkb24ndCBhY3R1YWxseSBkb2NrZXIgYnVpbGRcbiAgICAgIHRocm93IG5ldyBFcnJvcignU1RPUFRFU1QnKTtcbiAgICB9LFxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJy9mb28nLFxuICAgIHJlcG9zaXRvcnlOYW1lOiAnc29tZS1uYW1lJyxcbiAgICBpbWFnZVRhZzogJ2ltYWdlLXRhZycsXG4gICAgc291cmNlSGFzaDogJzAxMjM0NTY3ODlhYmNkZWYnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KCcuJywgYXNzZXQsIHRvb2xraXQsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL1NUT1BURVNULy50ZXN0KGUudG9TdHJpbmcoKSkpIHsgdGhyb3cgZTsgfVxuICB9XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoY3JlYXRlZE5hbWUpLnRvQmUoJ3NvbWUtbmFtZScpO1xufSk7XG5cbnRlc3QoJ2NvbmZpZ3VyZXMgaW1hZ2Ugc2Nhbm5pbmcnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGxldCBwdXRJbWFnZVNjYW5uaW5nQ29uZmlndXJhdGlvblBhcmFtcztcblxuICBjb25zdCBzZGsgPSBuZXcgTW9ja1NESygpO1xuICBzZGsuc3R1YkVjcih7XG4gICAgZGVzY3JpYmVSZXBvc2l0b3JpZXM6ICgpID0+ICh7IHJlcG9zaXRvcmllczogW10gfSksXG4gICAgY3JlYXRlUmVwb3NpdG9yeTogKCkgPT4gKHsgcmVwb3NpdG9yeTogeyByZXBvc2l0b3J5VXJpOiAndXJpJyB9IH0pLFxuICAgIHB1dEltYWdlU2Nhbm5pbmdDb25maWd1cmF0aW9uOiBwYXJhbXMgPT4ge1xuICAgICAgcHV0SW1hZ2VTY2FubmluZ0NvbmZpZ3VyYXRpb25QYXJhbXMgPSBwYXJhbXM7XG5cbiAgICAgIC8vIFN0b3AgdGhlIHRlc3Qgc28gdGhhdCB3ZSBkb24ndCBhY3R1YWxseSBkb2NrZXIgYnVpbGRcbiAgICAgIHRocm93IG5ldyBFcnJvcignU1RPUFRFU1QnKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHRvb2xraXQgPSBuZXdNb2NrVG9vbGtpdEluZm8oc2RrKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJy9mb28nLFxuICAgIHJlcG9zaXRvcnlOYW1lOiAnc29tZS1uYW1lJyxcbiAgICBpbWFnZVRhZzogJ3NvbWUtdGFnJyxcbiAgICBzb3VyY2VIYXNoOiAnMDEyMzQ1Njc4OWFiY2RlZicsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcmVwYXJlQ29udGFpbmVyQXNzZXQoJy4nLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEvU1RPUFRFU1QvLnRlc3QoZS50b1N0cmluZygpKSkgeyB0aHJvdyBlOyB9XG4gIH1cblxuICBleHBlY3QocHV0SW1hZ2VTY2FubmluZ0NvbmZpZ3VyYXRpb25QYXJhbXMpLnRvRXF1YWwoe1xuICAgIHJlcG9zaXRvcnlOYW1lOiAnc29tZS1uYW1lJyxcbiAgICBpbWFnZVNjYW5uaW5nQ29uZmlndXJhdGlvbjoge1xuICAgICAgc2Nhbk9uUHVzaDogdHJ1ZVxuICAgIH1cbiAgfSk7XG59KTtcblxudGVzdCgncGFzc2VzIHRoZSBjb3JyZWN0IHRhcmdldCB0byBkb2NrZXIgYnVpbGQnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHRvb2xraXQgPSBuZXdNb2NrVG9vbGtpdEluZm8oKTtcblxuICBjb25zdCBwcmVwYXJlRWNyUmVwb3NpdG9yeVN0dWIgPSBzaW5vbi5zdHViKHRvb2xraXQsICdwcmVwYXJlRWNyUmVwb3NpdG9yeScpLnJlc29sdmVzKHsgcmVwb3NpdG9yeVVyaTogJ3VyaScgfSk7XG4gIGNvbnN0IGNoZWNrRWNySW1hZ2VTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAnY2hlY2tFY3JJbWFnZScpLnJlc29sdmVzKGZhbHNlKTtcbiAgY29uc3Qgc2hlbGxTdHViID0gc2lub24uc3R1YihvcywgJ3NoZWxsJykucmVqZWN0cygnU1RPUFRFU1QnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJy9mb28nLFxuICAgIHNvdXJjZUhhc2g6ICcxMjM0NTY3ODkwYWJjZGVmJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgaW1hZ2VUYWc6ICdzb21lLXRhZycsXG4gICAgYnVpbGRBcmdzOiB7XG4gICAgICBhOiAnYicsXG4gICAgICBjOiAnZCdcbiAgICB9LFxuICAgIHRhcmdldDogJ2EtdGFyZ2V0JyxcbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IHByZXBhcmVDb250YWluZXJBc3NldCgnLicsIGFzc2V0LCB0b29sa2l0LCBmYWxzZSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoIS9TVE9QVEVTVC8udGVzdChlLnRvU3RyaW5nKCkpKSB7IHRocm93IGU7IH1cbiAgfVxuXG4gIC8vIFRIRU5cbiAgY29uc3QgY29tbWFuZCA9IFsgJ2RvY2tlcicsICdidWlsZCcsICctLXRhZycsIGB1cmk6c29tZS10YWdgLCAnLS10YXJnZXQnLCAnYS10YXJnZXQnLCAnLS1idWlsZC1hcmcnLCAnYT1iJywgJy0tYnVpbGQtYXJnJywgJ2M9ZCcsICcvZm9vJyBdO1xuICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChzaGVsbFN0dWIsIGNvbW1hbmQpO1xuXG4gIHByZXBhcmVFY3JSZXBvc2l0b3J5U3R1Yi5yZXN0b3JlKCk7XG4gIHNoZWxsU3R1Yi5yZXN0b3JlKCk7XG4gIGNoZWNrRWNySW1hZ2VTdHViLnJlc3RvcmUoKTtcbn0pO1xuXG50ZXN0KCdwYXNzZXMgdGhlIGNvcnJlY3QgYXJncyB0byBkb2NrZXIgYnVpbGQnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHRvb2xraXQgPSBuZXdNb2NrVG9vbGtpdEluZm8oKTtcblxuICBjb25zdCBwcmVwYXJlRWNyUmVwb3NpdG9yeVN0dWIgPSBzaW5vbi5zdHViKHRvb2xraXQsICdwcmVwYXJlRWNyUmVwb3NpdG9yeScpLnJlc29sdmVzKHsgcmVwb3NpdG9yeVVyaTogJ3VyaScgfSk7XG4gIGNvbnN0IGNoZWNrRWNySW1hZ2VTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAnY2hlY2tFY3JJbWFnZScpLnJlc29sdmVzKGZhbHNlKTtcbiAgY29uc3Qgc2hlbGxTdHViID0gc2lub24uc3R1YihvcywgJ3NoZWxsJykucmVqZWN0cygnU1RPUFRFU1QnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJy9mb28nLFxuICAgIHNvdXJjZUhhc2g6ICcxMjM0NTY3ODkwYWJjZGVmJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgaW1hZ2VUYWc6ICdzb21lLXRhZycsXG4gICAgYnVpbGRBcmdzOiB7XG4gICAgICBhOiAnYicsXG4gICAgICBjOiAnZCdcbiAgICB9XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcmVwYXJlQ29udGFpbmVyQXNzZXQoJy4nLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEvU1RPUFRFU1QvLnRlc3QoZS50b1N0cmluZygpKSkgeyB0aHJvdyBlOyB9XG4gIH1cblxuICAvLyBUSEVOXG4gIGNvbnN0IGNvbW1hbmQgPSBbJ2RvY2tlcicsICdidWlsZCcsICctLXRhZycsIGB1cmk6c29tZS10YWdgLCAnLS1idWlsZC1hcmcnLCAnYT1iJywgJy0tYnVpbGQtYXJnJywgJ2M9ZCcsICcvZm9vJ107XG4gIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHNoZWxsU3R1YiwgY29tbWFuZCk7XG5cbiAgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViLnJlc3RvcmUoKTtcbiAgY2hlY2tFY3JJbWFnZVN0dWIucmVzdG9yZSgpO1xuICBzaGVsbFN0dWIucmVzdG9yZSgpO1xufSk7XG5cbnRlc3QoJ3Bhc3NlcyB0aGUgY29ycmVjdCBkb2NrZXIgZmlsZSBuYW1lIGlmIHNwZWNpZmllZCcsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgdG9vbGtpdCA9IG5ld01vY2tUb29sa2l0SW5mbygpO1xuICBjb25zdCBwcmVwYXJlRWNyUmVwb3NpdG9yeVN0dWIgPSBzaW5vbi5zdHViKHRvb2xraXQsICdwcmVwYXJlRWNyUmVwb3NpdG9yeScpLnJlc29sdmVzKHsgcmVwb3NpdG9yeVVyaTogJ3VyaScgfSk7XG4gIGNvbnN0IGNoZWNrRWNySW1hZ2VTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAnY2hlY2tFY3JJbWFnZScpLnJlc29sdmVzKGZhbHNlKTtcbiAgY29uc3Qgc2hlbGxTdHViID0gc2lub24uc3R1YihvcywgJ3NoZWxsJykucmVqZWN0cygnU1RPUFRFU1QnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJy9mb28nLFxuICAgIHNvdXJjZUhhc2g6ICcxMjM0NTY3ODkwYWJjZGVmJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgaW1hZ2VUYWc6ICdzb21lLXRhZycsXG4gICAgZmlsZTogJ0N1c3RvbURvY2tlcmZpbGUnLFxuICAgIGJ1aWxkQXJnczoge1xuICAgICAgYTogJ2InLFxuICAgICAgYzogJ2QnXG4gICAgfVxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KCcuJywgYXNzZXQsIHRvb2xraXQsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL1NUT1BURVNULy50ZXN0KGUudG9TdHJpbmcoKSkpIHsgdGhyb3cgZTsgfVxuICB9XG5cbiAgLy8gVEhFTlxuICBjb25zdCBjb21tYW5kID0gWydkb2NrZXInLCAnYnVpbGQnLCAnLS10YWcnLCBgdXJpOnNvbWUtdGFnYCwgJy0tZmlsZScsICcvZm9vL0N1c3RvbURvY2tlcmZpbGUnLCAnLS1idWlsZC1hcmcnLCAnYT1iJywgJy0tYnVpbGQtYXJnJywgJ2M9ZCcsICcvZm9vJ107XG4gIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHNoZWxsU3R1YiwgY29tbWFuZCk7XG5cbiAgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViLnJlc3RvcmUoKTtcbiAgY2hlY2tFY3JJbWFnZVN0dWIucmVzdG9yZSgpO1xuICBzaGVsbFN0dWIucmVzdG9yZSgpO1xufSk7XG5cbnRlc3QoJ3JlbGF0aXZlIHBhdGgnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHRvb2xraXQgPSBuZXdNb2NrVG9vbGtpdEluZm8oKTtcbiAgY29uc3QgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAncHJlcGFyZUVjclJlcG9zaXRvcnknKS5yZXNvbHZlcyh7IHJlcG9zaXRvcnlVcmk6ICd1cmknIH0pO1xuICBjb25zdCBjaGVja0VjckltYWdlU3R1YiA9IHNpbm9uLnN0dWIodG9vbGtpdCwgJ2NoZWNrRWNySW1hZ2UnKS5yZXNvbHZlcyhmYWxzZSk7XG4gIGNvbnN0IHNoZWxsU3R1YiA9IHNpbm9uLnN0dWIob3MsICdzaGVsbCcpLnJlamVjdHMoJ1NUT1BURVNUJyk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBhc3NldDogY3hhcGkuQ29udGFpbmVySW1hZ2VBc3NldE1ldGFkYXRhRW50cnkgPSB7XG4gICAgaWQ6ICdhc3NldElkJyxcbiAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgIHBhdGg6ICdyZWxhdGl2ZS10by1hc3NlbWJseScsXG4gICAgc291cmNlSGFzaDogJzEyMzQ1Njc4OTBhYmNkZWYnLFxuICAgIHJlcG9zaXRvcnlOYW1lOiAnc29tZS1uYW1lJyxcbiAgICBpbWFnZVRhZzogJ3NvbWUtdGFnJyxcbiAgICBidWlsZEFyZ3M6IHtcbiAgICAgIGE6ICdiJyxcbiAgICAgIGM6ICdkJ1xuICAgIH1cbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IHByZXBhcmVDb250YWluZXJBc3NldCgnL2Fzc2VtYmx5L2Rpci9yb290JywgYXNzZXQsIHRvb2xraXQsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL1NUT1BURVNULy50ZXN0KGUudG9TdHJpbmcoKSkpIHsgdGhyb3cgZTsgfVxuICB9XG5cbiAgLy8gVEhFTlxuICBjb25zdCBjb21tYW5kID0gWydkb2NrZXInLCAnYnVpbGQnLCAnLS10YWcnLCBgdXJpOnNvbWUtdGFnYCwgJy0tYnVpbGQtYXJnJywgJ2E9YicsICctLWJ1aWxkLWFyZycsICdjPWQnLCAnL2Fzc2VtYmx5L2Rpci9yb290L3JlbGF0aXZlLXRvLWFzc2VtYmx5J107XG4gIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHNoZWxsU3R1YiwgY29tbWFuZCk7XG5cbiAgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViLnJlc3RvcmUoKTtcbiAgY2hlY2tFY3JJbWFnZVN0dWIucmVzdG9yZSgpO1xuICBzaGVsbFN0dWIucmVzdG9yZSgpO1xufSk7XG5cbnRlc3QoJ3NraXBzIGJ1aWxkICYgcHVzaCBpZiBpbWFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRUNSIHJlcG8nLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHRvb2xraXQgPSBuZXdNb2NrVG9vbGtpdEluZm8oKTtcbiAgY29uc3QgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAncHJlcGFyZUVjclJlcG9zaXRvcnknKTtcbiAgY29uc3Qgc2hlbGxTdHViID0gc2lub24uc3R1YihvcywgJ3NoZWxsJyk7XG4gIGNvbnN0IGNoZWNrRWNySW1hZ2VTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAnY2hlY2tFY3JJbWFnZScpLnJlc29sdmVzKHRydWUpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgYXNzZXQ6IGN4YXBpLkNvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5ID0ge1xuICAgIGlkOiAnYXNzZXRJZCcsXG4gICAgcGFja2FnaW5nOiAnY29udGFpbmVyLWltYWdlJyxcbiAgICBwYXRoOiAncmVsYXRpdmUtdG8tYXNzZW1ibHknLFxuICAgIHNvdXJjZUhhc2g6ICcxMjM0NTY3ODkwYWJjZGVmJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgaW1hZ2VUYWc6ICdzb21lLXRhZycsXG4gICAgYnVpbGRBcmdzOiB7XG4gICAgICBhOiAnYicsXG4gICAgICBjOiAnZCdcbiAgICB9XG4gIH07XG5cbiAgYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KCcvYXNzZW1ibHkvZGlyL3Jvb3QnLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuXG4gIC8vIFRIRU5cbiAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UocHJlcGFyZUVjclJlcG9zaXRvcnlTdHViKTtcbiAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoY2hlY2tFY3JJbWFnZVN0dWIpO1xuICBzaW5vbi5hc3NlcnQubm90Q2FsbGVkKHNoZWxsU3R1Yik7XG59KTtcblxuZnVuY3Rpb24gbmV3TW9ja1Rvb2xraXRJbmZvKHNkazogTW9ja1NESyA9IG5ldyBNb2NrU0RLKCkpIHtcbiAgcmV0dXJuIG5ldyBUb29sa2l0SW5mbyh7XG4gICAgc2RrLFxuICAgIGJ1Y2tldE5hbWU6ICdCVUNLRVRfTkFNRScsXG4gICAgYnVja2V0RW5kcG9pbnQ6ICdCVUNLRVRfRU5EUE9JTlQnLFxuICAgIGVudmlyb25tZW50OiB7IG5hbWU6ICdlbnYnLCBhY2NvdW50OiAnMTIzNCcsIHJlZ2lvbjogJ2FiYycgfVxuICB9KTtcbn0iXX0=